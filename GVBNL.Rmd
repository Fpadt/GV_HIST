---
title: "Legacy Sales - GrandVision Benelux - "
author: "F.J.Padt"
date: "`r Sys.Date()`"
output: 
   pdf_document:
    toc:             true
    toc_depth:       2
    number_sections: true
    fig_caption:     true
    fig_crop:        true
    highlight:       tango    
---

\newpage
![Logo](http://www.grandvision.com/img/logoGV.png) 

```{r RSetup, echo=FALSE, eval=TRUE, cache=FALSE, results='hide'}

source('../QAR/00_RProj/00_Global/iSynGeneral.R')

# Data Settings
fECHO    <- FALSE
fEVAL    <- TRUE
fRESULTS <- 'hide' 

# SAP systems to use
pECC_SYST <- "RA1"
pECC_CLNT <- "250"
pBI_SYST  <- "BA1" 
pBI_CLNT  <- "200"
pLGCINDC  <- "C"

# Data Settings
pOPCO     <- "GVBNL"
pROWS     <- -1L
pSMALL    <- 1000
pEXP      <- FALSE
pPART     <- ""
pFILE     <- paste(  pOPCO             , pBI_SYST,      pPART, sep="_") 
pSRCF     <- paste0("GVBNL"       , "_", pBI_SYST, "_", pPART, ".csv")
pEXPORT   <- paste0("POS_HISTORY", "_" , pBI_SYST, "_", pPART, ".csv") 
pPath     <- "./60_Results"  
pXLSX     <- paste0(pOPCO, "_SALES") 

# Open Excel for storing results
if(file.exists(paste0(pPath, "/", pOPCO, ".xlsx")) == TRUE){
   file.remove(paste0(pPath, "/", pOPCO, ".xlsx"))
}

fWriteToSheet(data.frame(ECCSYST = pECC_SYST, 
                         ECCCLNT = pECC_CLNT,
                         BI_SYST = pBI_SYST ,
                         BI_CLNT = pBI_CLNT), 
              pPath, pOPCO, "PARAM"   , pAppend = FALSE )
```

```{r SplitVBRP, echo=FALSE, eval=FALSE, results='hide'}
# dtGVBNL     <- fread(file.path(".", "RAW_DATA", "GVBLX_HIST.txt"),  
#                      sep = ";", nrows = pROWS, colClasses="character") 
# 
# setnames(
#   dtGVBNL,
#   c("invoice_date", "store"         , "invoice_number" ,
#     "order_type"  , "article_number", "discount_reason", 
#     "link"        , "quantity"      , "discount"       , 
#     "tax_amount"  , "cost_amount"),
#   c("FKDAT"       , "LWRKS"         , "VBELN"          , 
#     "BSTNK_VF"    , "LMTNR"         , "RPA_DRC"        , 
#     "G1LINK"      , "FKIMG"         , "G1DISCIT"      , 
#     "MWSBP"       , "WAVWR"))
# 
# 
# l_months <- sort(unique(substr(dtGVBNL$invoice_date, 1, 6)))
# 
# write.table(dtGVBNL[substr(dtGVBNL$invoice_date, 1, 6) %in% l_months[1:6]], 
#             file = file.path("c:", "FTP", 
#                              paste0("GVBNL", "_", 
#                                     pBI_SYST, "_", "2014H1", ".csv")),
#             quote = TRUE     , sep = ";", na = "", dec = ".",           
#             row.names = FALSE, col.names = TRUE, append = FALSE)
# 
# write.table(dtVBRP[substr(dtGVBNL$invoice_date, 1, 6)  %in% l_months[7:12]], 
#             file = file.path("c:", "FTP", 
#                              paste0("GVBNL", "_",
#                                     pBI_SYST, "_", "2014H2", ".csv")),
#             quote = TRUE     , sep = ";", na = "", dec = ".",           
#             row.names = FALSE, col.names = TRUE, append = FALSE)
# 
# write.table(dtVBRP[substr(dtGVBNL$invoice_date, 1, 6) %in% l_months[13:17]], 
#             file = file.path("c:", "FTP", 
#                              paste0("GVBNL", "_", 
#                                     pBI_SYST, "_", "2015H2", ".csv")),
#             quote = TRUE     , sep = ";", na = "", dec = ".",           
#             row.names = FALSE, col.names = TRUE, append = FALSE)
# rm(list=ls())
```

```{r ReadRawData, echo=fECHO, eval=fEVAL}

dtMEAN       <- fGetTable(pTable = "MEAN", pKey = c("MATNR", "MEINH"),
                          pSystID = pECC_SYST, pClient = pECC_CLNT)
dtMEAN       <- dtMEAN[, MATNR:= as.character(MATNR)]

dtADRC       <- fGetTable(pTable = "ADRC", 
                          pSystID = pECC_SYST, pClient = pECC_CLNT)

dtT001W      <- fGetTable(pTable = "T001W", pKey = c("WERKS"),
                          pSystID = pECC_SYST, pClient = pECC_CLNT)

dtPLANT      <- fGetTable(pTable = "/BI0/PPLANT",
                          pKey = "PLANT",
                          pSystID = pBI_SYST, pClient = pBI_CLNT)

dtRSDSSEGFD  <- fGetTable(pTable = "RSDSSEGFD", 
                          pKey = c("DATASOURCE", "POSIT"),
                          pSystID = pBI_SYST, pClient = pBI_CLNT)
dtRSDSSEGFD  <- dtRSDSSEGFD[DATASOURCE == "G0_DS_LEGACY_SLS_TD" ]

dtRSDSSEGFDT <- fGetTable(pTable = "RSDSSEGFDT", 
                          pKey = c("DATASOURCE", "POSIT"), 
                          pSystID = pBI_SYST, pClient = pBI_CLNT)
dtRSDSSEGFDT <- dtRSDSSEGFDT[DATASOURCE == "G0_DS_LEGACY_SLS_TD" ]



dtSDP_BLX    <- fread(file.path(".", "RAW_DATA", "SDP_BLX.csv"), 
                      sep=";")
setkey(dtSDP_BLX, "WERKS")

dtDATA     <- fread(file.path(".", "RAW_DATA", "GVBLX_HIST.txt"),  
                    sep = ";", nrows = pROWS, colClasses="character") 

dtCL       <- fread(file.path(".", "RAW_DATA", "GVBLX_HIST_20150717.txt"), 
                    sep=";", colClasses="character")

dtGL       <- fread(file.path(".", "RAW_DATA", "ttSalesHist.prd.20150720.csv"), 
                    sep=";", colClasses="character")
dtGL <- dtGL[, ART:= gsub("\"", "", dtGL[1]$Art.nr.)]


setnames(
  dtDATA,
  c("invoice_date", "store"         , "invoice_number" ,
    "order_type"  , "article_number", "discount_reason", 
    "link"        , "quantity"      , "discount"       , 
    "tax_amount"  , "cost_amount"   , "net_sales_incl_tax",
    "wholesale_price"),
  c("FKDAT"       , "LWRKS"         , "VBELN"          , 
    "BSTNK_VF"    , "LMTNR"         , "RPA_DRC"        , 
    "G1LINK"      , "FKIMG"         , "G1DISCIT"      , 
    "MWSBP"       , "WAVWR"         , "NSITX",
    "RETTRCOST"))

```

# Historical Data #

The historical data for `r pOPCO` is extracted from Navison as one big data set. 
This set is turned into a  subset of the standard SAP extractor 
2LIS_13_VDITM which is used in the iSynery Project.

From:    `r min(dtDATA$FKDAT)` 
To:      `r max(dtDATA$FKDAT)`
Records: `r nrow(dtDATA)`

## Source Data 

```{r PrepareDataSet, echo=fECHO, eval=fEVAL, results=fRESULTS}
dtTMP04 <- dtDATA[LMTNR == " " |
                  LMTNR == ""  |  
                  (LMTNR == 0 & article_group == "NL")  ] 

# 6 Invalid records
fWriteToSheet(dtTMP04, 
              pPath, pXLSX, "LMTNR_MISSING", pAppend = TRUE)
dtDATA <- dtDATA[LMTNR != " "]
dtDATA <- dtDATA[LMTNR != ""]
dtDATA <- dtDATA[!(LMTNR == 0 & article_group == "NL")] 
dtDATA <- dtDATA[article_group %in% c("NL", "CL")] 
  
# remove leading zero's
dtDATA <- dtDATA[, LMTNR:= gsub("(^|[^0-9])0+", "\\1", LMTNR, perl = TRUE)]

# gc()
```

Below the structure of the source data and the number of records is displayed

```{r displayDetailMean, echo=fECHO, eval=fEVAL, results='markup'}

str(dtDATA)
head(dtDATA[, c(1:7)             , with = FALSE])
head(dtDATA[, c(8 :ncol(dtDATA)) , with = FALSE])
# head(dtDATA[, c(16:23)           , with = FALSE])
# head(dtDATA[, c(24:ncol(dtDATA)) , with = FALSE])

# fWriteToSheet(as.data.frame(str(dtDATA)), pFILE, "Structure", pAppend = TRUE)
fWriteToSheet(head(dtDATA[1:10]), 
               pPath, pXLSX, "DATA"   , pAppend = TRUE)
```

```{r ChangeDataTypes, echo=fECHO, eval=fEVAL, results=fRESULTS}
# Change data Types and set NA to 0
system.time(
  dtDATA <- dtDATA[, `:=`(
    VBELN     = paste0("H", str_pad(VBELN, 9, pad="0")),
    RPA_DRC   = toupper(x = RPA_DRC),
    LWRKS     = str_pad(LWRKS, 4, pad ="0"),
    FKIMG     = ifelse(is.na(FKIMG), 0, as.integer(FKIMG)),
    FKLMG     = ifelse(is.na(FKIMG), 0, as.integer(FKIMG)),
#    KZWI1     = 0 ,# ifelse(is.na(NSITX) , 0, as.numeric(sub(",", ".", NSITX ))),
#    KZWI2     = 0, # ifelse(is.na(KZWI2), 0, as.numeric(sub(",", ".", KZWI2))),
#    KZWI3     = 0, # ifelse(is.na(KZWI3), 0, as.numeric(sub(",", ".", KZWI3))),
#    KZWI4     = 0, # ifelse(is.na(KZWI4), 0, as.numeric(sub(",", ".", KZWI4))),
#    KZWI5     = 0, # ifelse(is.na(KZWI5), 0, as.numeric(sub(",", ".", KZWI5))),    
#    KZWI6     = 0, # ifelse(is.na(KZWI6), 0, as.numeric(sub(",", ".", KZWI6))),
    NSITX      = ifelse(is.na(NSITX), 0, as.numeric(sub(",", ".", NSITX))),
    G1DISCIT   = ifelse(is.na(G1DISCIT), 0, 
                       as.numeric(sub(",", ".", G1DISCIT))),
    MWSBP     = ifelse(is.na(MWSBP), 0, as.numeric(sub(",", ".", MWSBP))),
    WAVWR     = ifelse(is.na(WAVWR), 0, as.numeric(sub(",", ".", WAVWR))), 
    ORGSCCOST = ifelse(is.na(WAVWR), 0, as.numeric(sub(",", ".", WAVWR))),
    RETTRCOST = ifelse(is.na(RETTRCOST ), 0, 
                       as.numeric(sub(",", ".", RETTRCOST ))) ) ])

  dtDATA <- dtDATA[, `:=`(
    NETWR     = NSITX - MWSBP)
    ]
  setkey(dtDATA, "VBELN")
  dtDATA <- dtDATA[, POSNR:= seq(from=1, to=.N, by=1), 
                   by=c("VBELN", "LWRKS", "FKDAT")]

gc()
```

### Data Preparation

The column names of the GVBNL data are changed to the BI object names for Mapping.
Secondly the decimal separator ',' is replaced by a '.'.
Finally non-existing key figures or set to 0.

```{r displayDetailMean2, echo=fECHO, eval=fEVAL, results='markup'}
str(dtDATA)
head(dtDATA)
```

### Data Source

```{r LegacyStoreToSAP, echo=fECHO, results=fRESULTS}
# add the iSynergy Store next to the legacy store
# timing: 18 sec.
setnames(dtADRC, "ADDRNUMBER", "ADRNR")
dtT001W <- dtT001W[, VTWEG:= as.character(VTWEG)]

dtWERKS  <- merge(dtT001W[ , .(ADRNR, WERKS, VKORG, VTWEG, VLFKZ)], 
                  dtADRC[  , .(ADRNR, SORT2)],
                  all.x = TRUE, by = "ADRNR")

# Select only NL stores
dtWERKS  <- dtWERKS[substr(VKORG, 1, 2) %in% c("NL", "BE")]

# Remove stores which are not Mapped
dtTMP01  <- dtWERKS[ is.na(SORT2)][, SORT2:= NULL]
fWriteToSheet(dtTMP01, 
              pPath, pXLSX, "WERKS_NO_SORT2", pAppend = TRUE )

dtWERKS  <- dtWERKS[!is.na(SORT2)] 

# Add Sales Org from list which include the closed Stores
dtSDP_01 <- copy(dtSDP_BLX)
setnames(dtSDP_01, "LWRKS", "SORT2")

dtWERKS  <- dtWERKS[, SORT2:= str_pad(SORT2, 4, pad ="0")]
dtWERKS  <- merge(dtWERKS[, .(WERKS, VTWEG, SORT2)], 
                   dtSDP_01, 
                   all.y = TRUE, by = "SORT2" )
dtWERKS <- dtWERKS[WERKS.y == "no SAP nr", WERKS.y:= WERKS.x]
dtWERKS <- dtWERKS[,WERKS.x:= NULL]
setnames(dtWERKS, 
         c("SORT2", "WERKS.y"), 
         c("LWRKS", "WERKS"  ))

# Quality check on Duplicates
dtWERKS  <- dtWERKS[, DUP:= duplicated(dtWERKS, by = "LWRKS")]

dtTMP02  <- copy(dtWERKS)
dtTMP02  <- dtTMP02[, DUP:= any(DUP)          , by = "LWRKS" ]
dtTMP02  <- dtTMP02[DUP == TRUE ]
fWriteToSheet(dtTMP02, 
              pPath, pXLSX, "WERKS_DUP", pAppend = TRUE )
fWriteToSheet(dtWERKS[DUP == TRUE], 
              pPath, pXLSX, "LWRKS_DEL", pAppend = TRUE )

dtWERKS  <- dtWERKS[DUP == FALSE][, DUP:=NULL]

# Add the iSynergy Site to the Data Set based upon Legacy site  

# stores With Sales
dtTMP05 <- as.data.table(setdiff(dtWERKS$LWRKS, unique(dtDATA$LWRKS) ))
fWriteToSheet(dtTMP05, 
              pPath, pXLSX, "LWRKS_wo_SLS", pAppend = TRUE )

dtWERKS <- dtWERKS[LWRKS %in% unique(dtDATA$LWRKS)]

# dtWERKS <- merge(data.table(LWRKS = unique(dtDATA$LWRKS)),
#                  dtWERKS[, .(LWRKS, WERKS)],
#                  all.x = TRUE, by = "LWRKS")

# Introduce dummy stores for closed stores which are not in iSYnergy
# Introduce dummy stores for closed stores which are not in iSYnergy
dtCWRKS <- dtWERKS[is.na(WERKS)]
dtCWRKS <- dtCWRKS[, WERKS:= paste0(pLGCINDC, 
                                    str_pad(100:(99 + nrow(dtCWRKS)), 
                                            3, pad ="0"))]

dtWERKS <- rbind(dtWERKS[!is.na(WERKS)],
                 dtCWRKS)

dtDATA  <- merge(dtWERKS, dtDATA, 
                 all.y = TRUE, by = "LWRKS")

rm(dtWERKS)
```

## Store Mapping

Following Stores could not be mapped and are removed from the store Master Data:

```{r Non-Mapped_Stores, echo=fECHO, eval=fEVAL, results=fRESULTS}
dtTMP01
dtTMP02
```


```{r LegacyArticleToSAP, echo=fECHO, eval=fEVAL }
# add the iSynergy Article next to the legacy article
dtMATNR <- dtMEAN[MEINH == "ST" & 
                  EANTP == "Z1" &
                  EAN11 != "DUPLICATE", 
                  .(MATNR, EAN11, EANTP)]
setnames(dtMATNR, c("EAN11"), c("LMTNR"))

# Quality check on Duplicates
dtMATNR  <- dtMATNR[, DUP:= duplicated(dtMATNR, by = "LMTNR")]

dtTMP03  <- copy(dtMATNR)
dtTMP03  <- dtTMP03[, DUP:= any(DUP)          , by = "LMTNR" ]
dtTMP03  <- dtTMP03[DUP == TRUE ][, DUP:=NULL]
fWriteToSheet(dtTMP03, 
              pPath, pXLSX, "MEAN_DUP", pAppend = TRUE )
fWriteToSheet(dtMATNR[DUP == TRUE], 
              pPath, pXLSX, "LMNTR_DEL", pAppend = TRUE )

dtMATNR  <- dtMATNR[DUP == FALSE][, DUP:=NULL]

# All Articles With Sales 
dtMATNR <- merge(data.table(LMTNR = unique(dtDATA$LMTNR)),
                 dtMATNR,
                 by = "LMTNR", all.x= TRUE)

# Introduce dummy Articles for Articles which are not in iSYnergy
dtHMTNR <- dtMATNR[is.na(MATNR)]
setkey(dtHMTNR, "LMTNR")
dtHMTNR <- dtHMTNR[, 
                   `:=` (EANTP = "Z1",
                         MATNR = paste0(pLGCINDC, 
                                        str_pad(100000:(99999 + 
                                                          nrow(dtHMTNR)), 
                                                17, pad ="0")))]

dtMATNR <- dtMATNR[!is.na(MATNR)]

dtMATNR <- rbind(dtHMTNR, dtMATNR)
setkey(dtMATNR, "MATNR")

dtDATA <- merge(dtMATNR, 
                dtDATA, 
                by = "LMTNR", all.y = TRUE )
```

```{r  Calculations, echo=fECHO, eval=fEVAL, results=fRESULTS}

# dtDATA <- dtDATA[, `:=`(
#   VGBEL      =   NA,     # lowercase not allowed in 0REFER_DOC
#   RPA_PAI    =            VBELN,     # Partner Number
#   EANTP      =             "Z1",     # Split by OPCO
# #   KZWI1      =    NETWR + MWSBP,     # Net valie inc. tax (note KZWI2 must be 0)
# #   KZWI2      =                0,     #
#   RPA_REAWT  =  (KZWI1 - KZWI2),     # Discount value including Tax   
#   RPA_DRC    =               NA,     # Discount reason           
#   G1LINK     =               NA,     # GVBNL lInk Field 
#   RECORDMODE =              "N")]    # Technical D,N,A,I         

```

```{r  Missing, echo=fECHO, eval=fEVAL}
# MISSING !!!!
dtDATA[, `:=`(STAT_CURR  =        "EUR",
              CURRENCY   =        "EUR",
              DOC_CURRCY =        "EUR",
 #             SUBTOT_4S  =            0,    # Subtotal 4
#              SUBTOT_5S  =            0,    # Subtotal 5
#              RPA_PAI    =           NA,    # Partner Number
#              CURTYPE    =         "00",    # Currency Type
#              STCURR     =         "EUR",
#              WAERK      =         "EUR",
              VRKME      =         "ST"
#,
#              MEINS      =         "ST"
               )]   # Original SC COGS

```


```{r}
# Get Datasource fields in the right order
dtDS         <- merge(dtRSDSSEGFD, 
                      dtRSDSSEGFDT[, .(POSIT, TXTLG )], 
                      by = "POSIT")
dtDS         <- dtDS[, .(SYSTID, DATASOURCE, POSIT, 
                         FIELDNM, DATATYPE, DECIMALS, IOBJNM,TXTLG)]

# Select and Order the fields in the same order as the DataSource
# dtDATA <- dtDATA[, dtDS$FIELDNM, with = FALSE]
```



```{r EXPORT, echo=fECHO, eval=fECHO}

setnames(
  dtDATA,
  c("FKDAT"       , "VBELN"         , "POSNR", 
    "BSTNK_VF"    , "LWRKS"         , "WERKS", 
    "VKORG"       , "VTWEG"         , "LMTNR",
    "MATNR"       , "FKIMG"         , "VRKME", 
    "NETWR"       , "MWSBP"         , "WAVWR"),
  c("SLSDATE"     , "BILL_NUM"      , "BILL_ITEM", 
    "RPA_TTC"     , "G1LGSTNO"      , "PLANT"    ,
    "SALESORG"    , "DISTR_CHAN"    , "G1LGART"  ,  
    "MATERIAL"    , "QUANTITY"      , "UNIT"     , 
    "NETVAL_INV"  , "TAX_AMOUNT"    , "RETPRCOST"))

# dtDS <- dtRSDSSEGFD[DATASOURCE == "G1_DS_PA_HIST_FLAT_FILE" & OBJVERS == "A"]
# setkey(dtDS, "POSIT")
# 
# dtDS <- dtDS[ , .(POSIT, FIELDNM, DATATYPE, DECIMALS, IOBJNM)]
# 
# 
dtDATA <- dtDATA[,
                 .(SLSDATE   , BILL_NUM, BILL_ITEM , RPA_TTC   ,
                   G1LGSTNO  , PLANT	 , SALESORG  , DISTR_CHAN,
                   G1LGART   , MATERIAL, RPA_DRC   , G1LINK    ,	
                   QUANTITY  , UNIT    , DOC_CURRCY, NETVAL_INV,
                   TAX_AMOUNT, G1DISCIT, ORGSCCOST , RETPRCOST,
                   RETTRCOST)]

# dtDATA <- dtDATA[!is.na(MATERIAL)]
# fWriteToSheet(dtDATA[1:1000], 
#               pPath, pXLSX, "EXAMPLE", pAppend = TRUE )
#                    
write.table(dtDATA, file = file.path("c:", "FTP", "GVBNL.csv"),
            quote = TRUE     , sep = ",", na = "", dec = ".",             
            row.names = FALSE, col.names = TRUE, append = FALSE)
```

